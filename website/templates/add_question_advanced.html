{% extends "base.html" %}

{% block title %}Добавление вопроса{% endblock %}

{% block content %}
<div class="container mt-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2>Добавление вопроса к тесту: {{ test.title }}</h2>
        <a href="{{ url_for('moderator.add_questions', test_id=test.id) }}" class="btn btn-outline-secondary">
            ← Назад к вопросам
        </a>
    </div>

    <div class="card">
        <div class="card-header">
            <h5>Новый вопрос</h5>
        </div>
        <div class="card-body">
            <form method="POST" enctype="multipart/form-data" id="question-form">
                {{ form.hidden_tag() }}


                <div class="mb-3">
                    {{ form.question.text.label(class="form-label") }}
                    {{ form.question.text(class="form-control", rows=3) }}
                    {% if form.question.text.errors %}
                    <div class="text-danger">
                        {% for error in form.question.text.errors %}
                        <small>{{ error }}</small>
                        {% endfor %}
                    </div>
                    {% endif %}
                </div>

                <!-- Тематика, сложность и параметры вопроса в одном блоке -->
                <div class="row mb-3">
                    <div class="col-md-4">
                        {{ form.question.topic.label(class="form-label") }}
                        {{ form.question.topic(class="form-control") }}
                    </div>
                    <div class="col-md-3">
                        {{ form.question.question_level.label(class="form-label") }}
                        {{ form.question.question_level(class="form-select") }}
                    </div>
                    <div class="col-md-3">
                        {{ form.question.points.label(class="form-label") }}
                        {{ form.question.points(class="form-control") }}
                    </div>
                    <div class="col-md-2">
                        {{ form.question.image.label(class="form-label") }}
                        {{ form.question.image(class="form-control") }}
                        <small class="text-muted">Изображение (опционально)</small>
                    </div>
                </div>

                <div class="row mb-3">
                    <div class="col-md-6">
                        {{ form.question.question_type.label(class="form-label") }}
                        {{ form.question.question_type(class="form-select", id="question-type") }}
                        <small class="text-muted" id="question-type-hint"></small>
                    </div>
                </div>

                <!-- Динамические поля в зависимости от типа вопроса -->
                <div id="answer-fields">
                    <!-- Для одиночных и множественных ответов -->
                    <div id="choice-answers-section" class="mb-3" style="display: none;">
                        <h5>Варианты ответов:</h5>
                        <div id="choice-answers">
                            {% for answer_form in form.question.answers %}
                            <div class="row mb-2 align-items-center answer-row" id="answer-row-{{ loop.index0 }}">
                                <div class="col-md-8">
                                    {{ answer_form.text(class="form-control answer-text", placeholder="Текст ответа") }}
                                </div>
                                <div class="col-md-3">
                                    <div class="form-check">
                                        {{ answer_form.is_correct(class="form-check-input answer-correct") }}
                                        {{ answer_form.is_correct.label(class="form-check-label") }}
                                    </div>
                                </div>
                                <div class="col-md-1">
                                    <button type="button" class="btn btn-outline-danger btn-sm remove-answer"
                                            data-index="{{ loop.index0 }}"
                                            style="display: {% if loop.index > 2 %}block{% else %}none{% endif %};">
                                        ✕
                                    </button>
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                        <button type="button" id="add-answer" class="btn btn-outline-primary btn-sm mt-2">
                            + Добавить вариант ответа
                        </button>
                        <small class="text-muted d-block mt-1">Отметьте правильные варианты галочкой</small>
                    </div>

                    <!-- Для текстовых ответов -->
                    <div id="text-answer-section" class="mb-3" style="display: none;">
                        <div class="mb-3">
                            {{ form.question.correct_text_answer.label(class="form-label") }}
                            {{ form.question.correct_text_answer(class="form-control", id="text-answer-input", placeholder="Например: сердце, аорта, 206") }}
                            <small class="text-muted">Введите правильный ответ для автоматической проверки</small>
                        </div>
                    </div>
                </div>

                <div class="d-flex justify-content-between mt-4">
                    <button type="submit" class="btn btn-primary">
                        <i class="bi bi-plus-circle"></i> Добавить вопрос
                    </button>
                    <a href="{{ url_for('moderator.add_questions', test_id=test.id) }}" class="btn btn-secondary">
                        Отмена
                    </a>
                </div>
            </form>
        </div>
    </div>

    <!-- Подсказки по типам вопросов -->
    <div class="card mt-3">
        <div class="card-header">
            <h6>Подсказки по типам вопросов:</h6>
        </div>
        <div class="card-body">
            <div class="row">
                <div class="col-md-4">
                    <div class="border rounded p-3 mb-2">
                        <strong>Один правильный ответ</strong>
                        <p class="mb-1 small">Пользователь выбирает один вариант из нескольких</p>
                        <small class="text-muted">Используйте для точных вопросов с одним ответом</small>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="border rounded p-3 mb-2">
                        <strong>Несколько правильных ответов</strong>
                        <p class="mb-1 small">Пользователь может выбрать несколько вариантов</p>
                        <small class="text-muted">Используйте когда правильных ответов несколько</small>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="border rounded p-3 mb-2">
                        <strong>Текстовый ответ</strong>
                        <p class="mb-1 small">Пользователь вводит ответ в текстовое поле</p>
                        <small class="text-muted">Используйте для ответов словами или числами</small>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- В add_question_advanced.html обновите JavaScript: -->
<script>
document.addEventListener('DOMContentLoaded', function() {
    const questionType = document.getElementById('question-type');
    const choiceAnswersSection = document.getElementById('choice-answers-section');
    const textAnswerSection = document.getElementById('text-answer-section');
    const questionTypeHint = document.getElementById('question-type-hint');
    const addAnswerBtn = document.getElementById('add-answer');
    const choiceAnswers = document.getElementById('choice-answers');
    let answerCount = {{ form.question.answers.entries|length }};

    // Подсказки для типов вопросов
    const typeHints = {
        'single': 'Выберите один правильный вариант',
        'multiple': 'Можно выбрать несколько правильных вариантов',
        'text': 'Пользователь введет ответ в текстовое поле'
    };

    function updateAnswerFields() {
        const type = questionType.value;

        // Обновляем подсказку
        questionTypeHint.textContent = typeHints[type] || '';

        // Показываем/скрываем соответствующие секции
        if (type === 'single' || type === 'multiple') {
            choiceAnswersSection.style.display = 'block';
            textAnswerSection.style.display = 'none';
        } else if (type === 'text') {
            choiceAnswersSection.style.display = 'none';
            textAnswerSection.style.display = 'block';
        }
    }

    // Обработчик изменения типа вопроса
    questionType.addEventListener('change', updateAnswerFields);

    // Инициализация при загрузке
    updateAnswerFields();

    // Добавление нового варианта ответа
    addAnswerBtn.addEventListener('click', function() {
        if (answerCount < 10) {
            const newIndex = answerCount;
            answerCount++;

            const newRow = document.createElement('div');
            newRow.className = 'row mb-2 align-items-center answer-row';
            newRow.id = `answer-row-${newIndex}`;

            if (questionType.value === 'single') {
                newRow.innerHTML = `
                    <div class="col-md-8">
                        <input type="text" class="form-control answer-text"
                               name="question-answers-${newIndex}-text"
                               placeholder="Текст ответа">
                    </div>
                    <div class="col-md-3">
                        <div class="form-check">
                            <input type="radio"
                                   class="form-check-input answer-correct"
                                   name="correct_answer"
                                   value="${newIndex}"
                                   id="answer-${newIndex}-correct">
                            <label class="form-check-label" for="answer-${newIndex}-correct">
                                Правильный
                            </label>
                        </div>
                    </div>
                    <div class="col-md-1">
                        <button type="button" class="btn btn-outline-danger btn-sm remove-answer"
                                data-index="${newIndex}">
                            ✕
                        </button>
                    </div>
                `;
            } else {
                newRow.innerHTML = `
                    <div class="col-md-8">
                        <input type="text" class="form-control answer-text"
                               name="question-answers-${newIndex}-text"
                               placeholder="Текст ответа">
                    </div>
                    <div class="col-md-3">
                        <div class="form-check">
                            <input type="checkbox"
                                   class="form-check-input answer-correct"
                                   name="question-answers-${newIndex}-is_correct"
                                   value="true"
                                   id="answer-${newIndex}-correct">
                            <label class="form-check-label" for="answer-${newIndex}-correct">
                                Правильный
                            </label>
                        </div>
                    </div>
                    <div class="col-md-1">
                        <button type="button" class="btn btn-outline-danger btn-sm remove-answer"
                                data-index="${newIndex}">
                            ✕
                        </button>
                    </div>
                `;
            }

            choiceAnswers.appendChild(newRow);

            // Показываем кнопки удаления для всех кроме первых двух
            document.querySelectorAll('.remove-answer').forEach(btn => {
                btn.style.display = 'block';
            });
        } else {
            alert('Максимум 10 вариантов ответа');
        }
    });

    // Удаление варианта ответа
    document.addEventListener('click', function(e) {
        if (e.target.classList.contains('remove-answer')) {
            const index = e.target.getAttribute('data-index');
            const row = document.getElementById(`answer-row-${index}`);
            if (row && answerCount > 2) {
                row.remove();
                answerCount--;

                // Обновляем индексы оставшихся ответов
                document.querySelectorAll('.answer-row').forEach((row, idx) => {
                    const inputs = row.querySelectorAll('input');
                    inputs.forEach(input => {
                        const name = input.getAttribute('name');
                        if (name && name.includes('question-answers-')) {
                            input.setAttribute('name', name.replace(/question-answers-\d+/, `question-answers-${idx}`));
                        }
                        if (input.type === 'radio' && input.name === 'correct_answer') {
                            input.value = idx;
                        }
                    });

                    const labels = row.querySelectorAll('label');
                    labels.forEach(label => {
                        const forAttr = label.getAttribute('for');
                        if (forAttr && forAttr.includes('answer-')) {
                            label.setAttribute('for', forAttr.replace(/answer-\d+/, `answer-${idx}`));
                        }
                    });

                    const removeBtn = row.querySelector('.remove-answer');
                    if (removeBtn) {
                        removeBtn.setAttribute('data-index', idx);
                    }

                    row.id = `answer-row-${idx}`;
                });

                // Скрываем кнопки удаления если осталось 2 ответа
                if (answerCount <= 2) {
                    document.querySelectorAll('.remove-answer').forEach(btn => {
                        btn.style.display = 'none';
                    });
                }
            }
        }
    });

    // Проверка формы перед отправкой
    document.getElementById('question-form').addEventListener('submit', function(e) {
        const type = questionType.value;
        let isValid = true;

        // Проверяем обязательные поля
        const questionText = document.querySelector('[name="question-text"]');
        if (!questionText || !questionText.value.trim()) {
            alert('Введите текст вопроса');
            isValid = false;
        }

        // Для текстовых вопросов проверяем правильный ответ
        if (type === 'text') {
            const correctAnswer = document.getElementById('text-answer-input');
            if (!correctAnswer || !correctAnswer.value.trim()) {
                alert('Введите правильный ответ для текстового вопроса');
                isValid = false;
            }
        }

        // Для вопросов с выбором проверяем что есть хотя бы один ответ
        if (type === 'single' || type === 'multiple') {
            const answerTexts = document.querySelectorAll('.answer-text');
            let hasAnswers = false;
            answerTexts.forEach(input => {
                if (input.value.trim()) {
                    hasAnswers = true;
                }
            });

            if (!hasAnswers) {
                alert('Добавьте хотя бы один вариант ответа');
                isValid = false;
            }

            // Для одиночного ответа проверяем что выбран правильный
            if (type === 'single') {
                const checkedRadio = document.querySelector('input[name="correct_answer"]:checked');
                if (!checkedRadio) {
                    alert('Выберите правильный вариант ответа');
                    isValid = false;
                }
            }
        }

        if (!isValid) {
            e.preventDefault();
        }
    });
});
</script>

<style>
.answer-row {
    transition: all 0.3s ease;
}

.answer-row:hover {
    background-color: #f8f9fa;
    border-radius: 5px;
    padding: 5px;
}

.remove-answer {
    width: 30px;
    height: 30px;
    padding: 0;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 12px;
}
</style>
{% endblock %}